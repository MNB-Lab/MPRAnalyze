---
title: "MPRAnalyze Tutorial"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
vignette: >
  %\VignetteEncoding{UTF-8}
---

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{MPRAnalyze Vignette}
-->

```{r options, cache=FALSE, include=FALSE, results='hide', message=FALSE, warning=FALSE}

knitr::opts_chunk$set(fig.align="center", 
                      cache=FALSE,
                      error=FALSE,
                      fig.width=6,fig.height=6,
                      autodep=TRUE,
                      out.width="600px", 
                      out.height="600px",
                      message=FALSE,
                      results="hide", 
                      echo=TRUE, 
                      eval=TRUE)

options(getClass.msg=FALSE)
```

# Introduction

MPRAnalyze is an analysis framework for MPRA data that aims at translating the main scientific questions arising in the context of MPRA data into statistical problems. Such questions include variations of ranking enhancers by caused expression magnitude and testing for differential enhancer activity between conditions. Thereby, MPRAnalyze allows the user to answer those questions as part of a likelihood-based framework based on p-values and expression strength scores.

The general idea is that most questions below can be answered based on hypothesis testing or significance testing of coefficients within a model:
A log-likelihood ratio test to compare a full and a reduced model or a t-test to test the significance of coefficients in a "full" model.
One can specifiy the factors included in the full and the reduced model in the wrapper function input, similar to a differential expression test.
The additional complexity lies in the fact that separately, additional model factors for the set of control/scrambled enhancers have to be defined in many scenarios.
Moreover, one has to supply factors which define the DNA model which is shared between full and reduced expression model.
The remaining questions which cannot be answered with a hypothesis test which are covered below can be answered by a quantitative comparison of the transcriptional activity / expression strength induced by an enhancer, which is also possible in this framework.

# Barcodes
MPRA experiments can be conducted with barcoded plasmids such that multiple plasmids with multiple barcodes are measured for each enhancer sequence (i.e. the plasmids are identitcal except for the barcode).
These barcodes are additional to the UMI barcodes.
Such plasmid barcoding may increase the reliability of the data and the added information can be used with MPRAnalyze.
We suggest to NOT MERGE the plasmid counts by barcode but to treat them as separate samples and to add the barcode identity into the DNA model as done below.

# Quantitative Analysis - single condition
# Comparative Analysis - multiple condition

---------------------------------------

# Without scrambled sequences
## Compare the strength of enhancers
Enhancers can be compared without a reference set based on their induced expression rates.
The analysis consists of the comparison of the scalar expression rate of each enhancer.
Enhancers can for example be ranked or compared to a reference (such as wild type) enhancer.

```{r without_scrambles_without_conditions, results='markdown'}
library(MPRAnalyze)
# I think the simulation doesnt allow one condition yet
# Produce example data: lognormal distributed DNA and poisson distributed RNA
sim <- simulateMPRA(n.case = 10, n.ctrl = 5, n.reps = 2, 
                    sd.dna.cond = 0.1, sd.dna.bc = 0.05, 
                    sd.rna = 1, sd.rna.cond = 0.5)
# Run MPRAnalyze
ctrls <- which(sim$rowAnnot$type == "ctrl")
if(length(ctrls)  == 0) {
    ctrls <- NULL
}
mpraobj <- MpraObject(dnaCounts=sim$dna, rnaCounts=sim$rna,
                      colAnnot=sim$colAnnot, controls=ctrls)
mpraobj <- estimateDepthFactors(mpraobj, lib.factor = "experiment")
# mpraobj <- setDepthFactors(mpraobj, rep(1, NCOL(sim$dna)), rep(1, NCOL(sim$dna)))
mpraobj <- analyze.quantitative(mpraobj, mode = "lrt", 
                                dnaDesign = ~ experiment, rnaDesign = ~ experiment)
#print(mpraobj@results)
```

## Test the effect of an condition
A hypothesis test is conducted to test whether expression varies significantly (= is non-constant) as a function of the given conditions(s).
The test does not take a "base line variation" into account which could be caputred with control enhancers.
Such a base line variation could be overall transcriptional activity.

```{r without_scrambles_with_conditions, results='markdown'}
# ln.nb: does not work
# gamma.pois: yes
# Produce example data: lognormal distributed DNA and poisson distributed RNA
sim <- simulateMPRA(n.case = 20, n.ctrl = 0, n.reps = 3,  
                    sd.dna.cond = 0.1, sd.dna.bc = 0.05, 
                    sd.rna = 1, sd.rna.cond = 0.5)
# Run MPRAnalyze
mpraobj <- MpraObject(dnaCounts=sim$dna, rnaCounts=sim$rna,
                      colAnnot=sim$colAnnot, controls=NULL)
mpraobj <- estimateDepthFactors(mpraobj)
mpraobj <- setModel(obj = mpraobj, model = "gamma.pois")
mpraobj <- analyze.comparative.lrt(obj = mpraobj,
                                   condition = "cond", mode = "nocontrols", 
                                   dnaDesign = ~barcode+cond, rnaDesign = ~cond)

```

```{r }
print(mpraobj@results)
plot(sim$rowAnnot$cond2_effect, log(mpraobj@results$pval))
plot(mpraobj@dnaCounts["case_1",], getDNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plot(mpraobj@rnaCounts["case_1",], getRNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plotBoxplots(mpraobj, "case_1", condition = "cond", batch = "rep")
plotBoxplots(mpraobj, "case_2", condition = "cond", batch = "rep")
plotBoxplots(mpraobj, "case_3", condition = "cond", batch = "rep")
```

```{r ttest, results='markdown'}
# ln.nb: does not work
# gamma.pois: yes
# devtools::load_all()
# Produce example data: lognormal distributed DNA and poisson distributed RNA
sim <- simulateMPRA(n.case = 20, n.ctrl = 5, n.reps = 2,  
                    sd.dna.cond = 0.1, sd.dna.bc = 0.05, 
                    sd.rna = 1, sd.rna.cond = 0.5)
ctrls <- which(sim$rowAnnot$type == "ctrl")
if(length(ctrls)  == 0) {
    ctrls <- NULL
}
# Run MPRAnalyze
mpraobj <- MpraObject(dnaCounts=sim$dna, rnaCounts=sim$rna,
                      colAnnot=sim$colAnnot, controls=ctrls)
mpraobj <- estimateDepthFactors(mpraobj)
mpraobj <- setModel(obj = mpraobj, model = "gamma.pois")
mpraobj <- analyze.comparative.coef(obj = mpraobj,
                                     dnaDesign = ~barcode+cond, 
                                     rnaDesign = ~cond)
res <- test.coefficient(mpraobj, factor = "cond", contrast = "cond_2")

```

# With scrambled/control enhancers
## Test the strength of enhancers
If control sequences are given and only one condition is analysed,
two approaches are possible:
Firstly, as without control sequences, enhancers can be compared by their induced expression rates.
Secondly, one can test whether the expression rates of the "case enhancers" differ significantly from the rates of the control enhancers.

```{r with_scrambles_without_conditions, results='markdown'}
# gamma.pois - full: yes
# gamma.pois - scaled: sometimes but plotting doesnt work?
# ln.nb - full: yes? worse than gamma.pois - full?
# ln.nb - scaled: yes but plotting doesnt work?
# devtools::load_all()
# 1 condition supported by simulation?
# Produce example data: lognormal distributed DNA and poisson distributed RNA
sim <- simulateMPRA(n.case = 10, n.ctrl = 10, n.reps = 3, n.cond = 1,
                    sd.dna.cond = 0.1, sd.dna.bc = 0.05, 
                    sd.rna = 1, sd.rna.cond = 0.5)
# Run MPRAnalyze
ctrls <- which(sim$rowAnnot$type == "ctrl")
if(length(ctrls)  == 0) {
    ctrls <- NULL
}
mpraobj <- MpraObject(dnaCounts=sim$dna, rnaCounts=sim$rna,
                      colAnnot=sim$colAnnot, controls=ctrls)
mpraobj <- estimateDepthFactors(mpraobj, "rep")
mpraobj <- setModel(mpraobj, "ln.nb")
mpraobj <- analyze.quantitative(obj=mpraobj, 
                                dnaDesign=~barcode, rnaDesign=~1, mode="empirical")
res <- test.empirical(mpraobj)
print(head(res))
```

```{r }
plot(mpraobj@dnaCounts["case_1",], getDNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plot(mpraobj@rnaCounts["case_1",], getRNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
#plotBoxplots(mpraobj, "case_1", batch = "rep")
#plotBoxplots(mpraobj, "case_2", batch = "rep")
#plotBoxplots(mpraobj, "ctrl_1", batch = "rep")
```
## Test the effect of an condition
A hypothesis test is conducted to test whether expression varies significantly (= is non-constant) as a function of the given conditions(s)
taking account for baseline variation captured be the control sequences.

### Scaled
```{r with_scrambles_with_conditions_scaled, results='markdown'}
# ln.nb: no
# gamma.pois: yes 
# Produce example data: lognormal distributed DNA and poisson distributed RNA
sim <- simulateMPRA(n.case = 10, n.ctrl = 5, n.reps = 3, 
                    sd.dna.cond = 0.1, sd.dna.bc = 0.05, 
                    sd.rna = 1, sd.rna.cond = 0.5)
# Run MPRAnalyze
ctrls <- which(sim$rowAnnot$type == "ctrl")
if(length(ctrls)  == 0) {
    ctrls <- NULL
}
mpraobj <- MpraObject(dnaCounts=sim$dna, rnaCounts=sim$rna,
                      colAnnot=sim$colAnnot, controls=ctrls)
#mpraobj <- estimateDepthFactors(mpraobj, lib.factor = "experiment", depthEstimator = "rle")
mpraobj <- estimateDepthFactors(mpraobj, "rep")
# mpraobj <- setDepthFactors(mpraobj, rep(1, NCOL(sim$dna)), rep(1, NCOL(sim$dna)))
mpraobj <- setModel(mpraobj, "ln.nb")
mpraobj <- analyze.comparative.lrt(mpraobj, mode="scaled",
    dnaDesign=~barcode+cond, rnaDesign=~cond, condition="cond")
results <- test.lrt(mpraobj)
print(results)
```

```{r }
plot(sim$rowAnnot$cond2_effect, log(mpraobj@results$pval))
plot(mpraobj@dnaCounts["case_1",], getDNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plot(mpraobj@rnaCounts["case_1",], getRNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plotBoxplots(mpraobj, "case_1", condition = "cond", batch = "rep")
plotBoxplots(mpraobj, "case_2", condition = "cond", batch = "rep")
```

### Full

```{r with_scrambles_with_conditions_full, results='markdown'}
# ln.nb:
# gamma.pois: yes
devtools::load_all()

# Produce example data: lognormal distributed DNA and poisson distributed RNA
sim <- simulateMPRA(n.case = 5, n.ctrl = 2, n.reps = 3, 
                    sd.dna.cond = 0.1, sd.dna.bc = 0.05, 
                    sd.rna = 1, sd.rna.cond = 0.5)
# Run MPRAnalyze
ctrls <- which(sim$rowAnnot$type == "ctrl")
if(length(ctrls)  == 0) {
    ctrls <- NULL
}
mpraobj <- MpraObject(dnaCounts=sim$dna, rnaCounts=sim$rna, ncores = 3,
                      colAnnot=sim$colAnnot, controls=ctrls)
mpraobj <- estimateDepthFactors(mpraobj, "rep")
mpraobj <- setModel(mpraobj, "ln.nb")
mpraobj <- analyze.comparative.lrt(obj = mpraobj, condition = "cond", 
                                   mode = "full", dnaDesign = ~barcode+cond, 
                                   rnaDesign = ~cond)
print(mpraobj@results)
```

```{r }
plot(sim$rowAnnot$cond2_effect, log(mpraobj@results$pval))
plot(mpraobj@dnaCounts["case_1",], getDNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plot(mpraobj@rnaCounts["case_1",], getRNAFits(mpraobj, enhancers=c("case_1"), full=TRUE))
abline(a = 0, b = 1, col="red")
plotBoxplots(mpraobj, "case_1", condition = "cond", batch = "rep")
plotBoxplots(mpraobj, "case_2", condition = "cond", batch = "rep")
```

# Plotting
MPRAnalyze compores distribution with each other and the results can be visualised using boxplots.

A useful reference for the overall results is also a histogram of the log10 FDR-corrected p-values:
```{r q-value histogram, results='markdown'}
hist(log(mpraobj@results$fdr.pval)/log(10))
```

# Session information

```{r session}
sessionInfo()
```